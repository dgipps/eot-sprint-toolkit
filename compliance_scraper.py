import json
import re
import requests


state_array = [
    "AK - AK - Alaska",
    "AL - AL - Alabama",
    "AR - AR - Arkansas",
    "AS - AS - American Samoa",
    "AT - AT - Atlantic Offshore",
    "AZ - AZ - Arizona",
    "CA - CA - California",
    "CO - CO - Colorado",
    "CT - CT - Connecticut",
    "DC - DC - Dist. Of Columbia",
    "DE - DE - Delaware",
    "FL - FL - Florida",
    "FM - FM - Fed. Micronesia",
    "GA - GA - Georgia",
    "GB - GB - George's Bank",
    "GM - GM - Gulf of Mexico",
    "GU - GU - Guam",
    "HI - HI - Hawaii",
    "IA - IA - Iowa",
    "ID - ID - Idaho",
    "IL - IL - Illinois",
    "IN - IN - Indiana",
    "JA - JA - Johnston Atoll",
    "KS - KS - Kansas",
    "KY - KY - Kentucky",
    "LA - LA - Louisiana",
    "MA - MA - Massachusetts",
    "MD - MD - Maryland",
    "ME - ME - Maine",
    "MH - MH - Marshall Islands",
    "MI - MI - Michigan",
    "MN - MN - Minnesota",
    "MO - MO - Missouri",
    "MP - MP - Mariana Islands",
    "MS - MS - Mississippi",
    "MT - MT - Montana",
    "MW - MW - Midway Islands",
    "NC - NC - North Carolina",
    "ND - ND - North Dakota",
    "NE - NE - Nebraska",
    "NH - NH - New Hampshire",
    "NI - NI - No. Marianas Isl.",
    "NJ - NJ - New Jersey",
    "NM - NM - New Mexico",
    "NN - NN - Navajo Nation",
    "NV - NV - Nevada",
    "NY - NY - New York",
    "OH - OH - Ohio",
    "OK - OK - Oklahoma",
    "OR - OR - Oregon",
    "PA - PA - Pennsylvania",
    "PR - PR - Puerto Rico",
    "PW - PW - Palau",
    "RI - RI - Rhode Island",
    "SC - SC - South Carolina",
    "SD - SD - South Dakota",
    "TN - TN - Tennessee",
    "TT - TT - Trust Territory",
    "TX - TX - Texas",
    "UM - UM - U.S. Minor Islands",
    "UT - UT - Utah",
    "VA - VA - Virginia",
    "VI - VI - Virgin Islands",
    "VT - VT - Vermont",
    "WA - WA - Washington",
    "WI - WI - Wisconsin",
    "WV - WV - West Virginia",
    "WY - WY - Wyoming",
]

counties = {
    'CA': [
        "Any   - California - all counties",
        "06001 - Alameda County",
        "06003 - Alpine County",
        "06005 - Amador County",
        "06007 - Butte County",
        "06009 - Calaveras County",
        "06011 - Colusa County",
        "06013 - Contra Costa County",
        "06015 - Del Norte County",
        "06017 - El Dorado County",
        "06019 - Fresno County",
        "06021 - Glenn County",
        "06023 - Humboldt County",
        "06025 - Imperial County",
        "06027 - Inyo County",
        "06029 - Kern County",
        "06031 - Kings County",
        "06033 - Lake County",
        "06035 - Lassen County",
        "06037 - Los Angeles County",
        "06039 - Madera County",
        "06041 - Marin County",
        "06043 - Mariposa County",
        "06045 - Mendocino County",
        "06047 - Merced County",
        "06049 - Modoc County",
        "06051 - Mono County",
        "06053 - Monterey County",
        "06055 - Napa County",
        "06057 - Nevada County",
        "06059 - Orange County",
        "06061 - Placer County",
        "06063 - Plumas County",
        "06065 - Riverside County",
        "06067 - Sacramento County",
        "06069 - San Benito County",
        "06071 - San Bernardino County",
        "06073 - San Diego County",
        "06075 - San Francisco County",
        "06077 - San Joaquin County",
        "06079 - San Luis Obispo County",
        "06081 - San Mateo County",
        "06083 - Santa Barbara County",
        "06085 - Santa Clara County",
        "06087 - Santa Cruz County",
        "06089 - Shasta County",
        "06091 - Sierra County",
        "06093 - Siskiyou County",
        "06095 - Solano County",
        "06097 - Sonoma County",
        "06099 - Stanislaus County",
        "06101 - Sutter County",
        "06103 - Tehama County",
        "06105 - Trinity County",
        "06107 - Tulare County",
        "06109 - Tuolumne County",
        "06111 - Ventura County",
        "06113 - Yolo County",
        "06115 - Yuba County",
    ],
    'FL': [
        "12001 - Alachua County",
        "12003 - Baker County",
        "12005 - Bay County",
        "12007 - Bradford County",
        "12009 - Brevard County",
        "12011 - Broward County",
        "12013 - Calhoun County",
        "12015 - Charlotte County",
        "12017 - Citrus County",
        "12019 - Clay County",
        "12021 - Collier County",
        "12023 - Columbia County",
        "12025 - Dade County (renamed Miami-Dade 12086)",
        "12027 - DeSoto County",
        "12029 - Dixie County",
        "12031 - Duval County",
        "12033 - Escambia County",
        "12035 - Flagler County",
        "12037 - Franklin County",
        "12039 - Gadsden County",
        "12041 - Gilchrist County",
        "12043 - Glades County",
        "12045 - Gulf County",
        "12047 - Hamilton County",
        "12049 - Hardee County",
        "12051 - Hendry County",
        "12053 - Hernando County",
        "12055 - Highlands County",
        "12057 - Hillsborough County",
        "12059 - Holmes County",
        "12061 - Indian River County",
        "12063 - Jackson County",
        "12065 - Jefferson County",
        "12067 - Lafayette County",
        "12069 - Lake County",
        "12071 - Lee County",
        "12073 - Leon County",
        "12075 - Levy County",
        "12077 - Liberty County",
        "12079 - Madison County",
        "12081 - Manatee County",
        "12083 - Marion County",
        "12085 - Martin County",
        "12025 - Miami-Dade County",
        "12087 - Monroe County",
        "12089 - Nassau County",
        "12091 - Okaloosa County",
        "12093 - Okeechobee County",
        "12095 - Orange County",
        "12097 - Osceola County",
        "12099 - Palm Beach County",
        "12101 - Pasco County",
        "12103 - Pinellas County",
        "12105 - Polk County",
        "12107 - Putnam County",
        "12109 - St. Johns County",
        "12111 - St. Lucie County",
        "12113 - Santa Rosa County",
        "12115 - Sarasota County",
        "12117 - Seminole County",
        "12119 - Sumter County",
        "12121 - Suwannee County",
        "12123 - Taylor County",
        "12125 - Union County",
        "12127 - Volusia County",
        "12129 - Wakulla County",
        "12131 - Walton County",
        "12133 - Washington County",
    ],
    'IL': [
        "17001 - Adams County",
        "17003 - Alexander County",
        "17005 - Bond County",
        "17007 - Boone County",
        "17009 - Brown County",
        "17011 - Bureau County",
        "17013 - Calhoun County",
        "17015 - Carroll County",
        "17017 - Cass County",
        "17019 - Champaign County",
        "17021 - Christian County",
        "17023 - Clark County",
        "17025 - Clay County",
        "17027 - Clinton County",
        "17029 - Coles County",
        "17031 - Cook County",
        "17033 - Crawford County",
        "17035 - Cumberland County",
        "17037 - DeKalb County",
        "17039 - De Witt County",
        "17041 - Douglas County",
        "17043 - DuPage County",
        "17045 - Edgar County",
        "17047 - Edwards County",
        "17049 - Effingham County",
        "17051 - Fayette County",
        "17053 - Ford County",
        "17055 - Franklin County",
        "17057 - Fulton County",
        "17059 - Gallatin County",
        "17061 - Greene County",
        "17063 - Grundy County",
        "17065 - Hamilton County",
        "17067 - Hancock County",
        "17069 - Hardin County",
        "17071 - Henderson County",
        "17073 - Henry County",
        "17075 - Iroquois County",
        "17077 - Jackson County",
        "17079 - Jasper County",
        "17081 - Jefferson County",
        "17083 - Jersey County",
        "17085 - Jo Daviess County",
        "17087 - Johnson County",
        "17089 - Kane County",
        "17091 - Kankakee County",
        "17093 - Kendall County",
        "17095 - Knox County",
        "17097 - Lake County",
        "17099 - La Salle County",
        "17101 - Lawrence County",
        "17103 - Lee County",
        "17105 - Livingston County",
        "17107 - Logan County",
        "17109 - McDonough County",
        "17111 - McHenry County",
        "17113 - McLean County",
        "17115 - Macon County",
        "17117 - Macoupin County",
        "17119 - Madison County",
        "17121 - Marion County",
        "17123 - Marshall County",
        "17125 - Mason County",
        "17127 - Massac County",
        "17129 - Menard County",
        "17131 - Mercer County",
        "17133 - Monroe County",
        "17135 - Montgomery County",
        "17137 - Morgan County",
        "17139 - Moultrie County",
        "17141 - Ogle County",
        "17143 - Peoria County",
        "17145 - Perry County",
        "17147 - Piatt County",
        "17149 - Pike County",
        "17151 - Pope County",
        "17153 - Pulaski County",
        "17155 - Putnam County",
        "17157 - Randolph County",
        "17159 - Richland County",
        "17161 - Rock Island County",
        "17163 - St. Clair County",
        "17165 - Saline County",
        "17167 - Sangamon County",
        "17169 - Schuyler County",
        "17171 - Scott County",
        "17173 - Shelby County",
        "17175 - Stark County",
        "17177 - Stephenson County",
        "17179 - Tazewell County",
        "17181 - Union County",
        "17183 - Vermilion County",
        "17185 - Wabash County",
        "17187 - Warren County",
        "17189 - Washington County",
        "17191 - Wayne County",
        "17193 - White County",
        "17195 - Whiteside County",
        "17197 - Will County",
        "17199 - Williamson County",
        "17201 - Winnebago County",
        "17203 - Woodford County",
    ],
    'MN': [
        "27001 - Aitkin County",
        "27003 - Anoka County",
        "27005 - Becker County",
        "27007 - Beltrami County",
        "27009 - Benton County",
        "27011 - Big Stone County",
        "27013 - Blue Earth County",
        "27015 - Brown County",
        "27017 - Carlton County",
        "27019 - Carver County",
        "27021 - Cass County",
        "27023 - Chippewa County",
        "27025 - Chisago County",
        "27027 - Clay County",
        "27029 - Clearwater County",
        "27031 - Cook County",
        "27033 - Cottonwood County",
        "27035 - Crow Wing County",
        "27037 - Dakota County",
        "27039 - Dodge County",
        "27041 - Douglas County",
        "27043 - Faribault County",
        "27045 - Fillmore County",
        "27047 - Freeborn County",
        "27049 - Goodhue County",
        "27051 - Grant County",
        "27053 - Hennepin County",
        "27055 - Houston County",
        "27057 - Hubbard County",
        "27059 - Isanti County",
        "27061 - Itasca County",
        "27063 - Jackson County",
        "27065 - Kanabec County",
        "27067 - Kandiyohi County",
        "27069 - Kittson County",
        "27071 - Koochiching County",
        "27073 - Lac qui Parle County",
        "27075 - Lake County",
        "27077 - Lake of the Woods County",
        "27079 - Le Sueur County",
        "27081 - Lincoln County",
        "27083 - Lyon County",
        "27085 - McLeod County",
        "27087 - Mahnomen County",
        "27089 - Marshall County",
        "27091 - Martin County",
        "27093 - Meeker County",
        "27095 - Mille Lacs County",
        "27097 - Morrison County",
        "27099 - Mower County",
        "27101 - Murray County",
        "27103 - Nicollet County",
        "27105 - Nobles County",
        "27107 - Norman County",
        "27109 - Olmsted County",
        "27111 - Otter Tail County",
        "27113 - Pennington County",
        "27115 - Pine County",
        "27117 - Pipestone County",
        "27119 - Polk County",
        "27121 - Pope County",
        "27123 - Ramsey County",
        "27125 - Red Lake County",
        "27127 - Redwood County",
        "27129 - Renville County",
        "27131 - Rice County",
        "27133 - Rock County",
        "27135 - Roseau County",
        "27137 - St. Louis County",
        "27139 - Scott County",
        "27141 - Sherburne County",
        "27143 - Sibley County",
        "27145 - Stearns County",
        "27147 - Steele County",
        "27149 - Stevens County",
        "27151 - Swift County",
        "27153 - Todd County",
        "27155 - Traverse County",
        "27157 - Wabasha County",
        "27159 - Wadena County",
        "27161 - Waseca County",
        "27163 - Washington County",
        "27165 - Watonwan County",
        "27167 - Wilkin County",
        "27169 - Winona County",
        "27171 - Wright County",
        "27173 - Yellow Medicine County",
    ],
    'NJ': [
        "34001 - Atlantic County",
        "34003 - Bergen County",
        "34005 - Burlington County",
        "34007 - Camden County",
        "34009 - Cape May County",
        "34011 - Cumberland County",
        "34013 - Essex County",
        "34015 - Gloucester County",
        "34017 - Hudson County",
        "34019 - Hunterdon County",
        "34021 - Mercer County",
        "34023 - Middlesex County",
        "34025 - Monmouth County",
        "34027 - Morris County",
        "34029 - Ocean County",
        "34031 - Passaic County",
        "34033 - Salem County",
        "34035 - Somerset County",
        "34037 - Sussex County",
        "34039 - Union County",
        "34041 - Warren County",
    ],
    'NY': [
        "36001 - Albany County",
        "36003 - Allegany County",
        "36005 - Bronx County",
        "36007 - Broome County",
        "36009 - Cattaraugus County",
        "36011 - Cayuga County",
        "36013 - Chautauqua County",
        "36015 - Chemung County",
        "36017 - Chenango County",
        "36019 - Clinton County",
        "36021 - Columbia County",
        "36023 - Cortland County",
        "36025 - Delaware County",
        "36027 - Dutchess County",
        "36029 - Erie County",
        "36031 - Essex County",
        "36033 - Franklin County",
        "36035 - Fulton County",
        "36037 - Genesee County",
        "36039 - Greene County",
        "36041 - Hamilton County",
        "36043 - Herkimer County",
        "36045 - Jefferson County",
        "36047 - Kings County",
        "36049 - Lewis County",
        "36051 - Livingston County",
        "36053 - Madison County",
        "36055 - Monroe County",
        "36057 - Montgomery County",
        "36059 - Nassau County",
        "36061 - New York County",
        "36063 - Niagara County",
        "36065 - Oneida County",
        "36067 - Onondaga County",
        "36069 - Ontario County",
        "36071 - Orange County",
        "36073 - Orleans County",
        "36075 - Oswego County",
        "36077 - Otsego County",
        "36079 - Putnam County",
        "36081 - Queens County",
        "36083 - Rensselaer County",
        "36085 - Richmond County",
        "36087 - Rockland County",
        "36089 - St. Lawrence County",
        "36091 - Saratoga County",
        "36093 - Schenectady County",
        "36095 - Schoharie County",
        "36097 - Schuyler County",
        "36099 - Seneca County",
        "36101 - Steuben County",
        "36103 - Suffolk County",
        "36105 - Sullivan County",
        "36107 - Tioga County",
        "36109 - Tompkins County",
        "36111 - Ulster County",
        "36113 - Warren County",
        "36115 - Washington County",
        "36117 - Wayne County",
        "36119 - Westchester County",
        "36121 - Wyoming County",
        "36123 - Yates County",
    ],
    'TX': [
        "48001 - Anderson County",
        "48003 - Andrews County",
        "48005 - Angelina County",
        "48007 - Aransas County",
        "48009 - Archer County",
        "48011 - Armstrong County",
        "48013 - Atascosa County",
        "48015 - Austin County",
        "48017 - Bailey County",
        "48019 - Bandera County",
        "48021 - Bastrop County",
        "48023 - Baylor County",
        "48025 - Bee County",
        "48027 - Bell County",
        "48029 - Bexar County",
        "48031 - Blanco County",
        "48033 - Borden County",
        "48035 - Bosque County",
        "48037 - Bowie County",
        "48039 - Brazoria County",
        "48041 - Brazos County",
        "48043 - Brewster County",
        "48045 - Briscoe County",
        "48047 - Brooks County",
        "48049 - Brown County",
        "48051 - Burleson County",
        "48053 - Burnet County",
        "48055 - Caldwell County",
        "48057 - Calhoun County",
        "48059 - Callahan County",
        "48061 - Cameron County",
        "48063 - Camp County",
        "48065 - Carson County",
        "48067 - Cass County",
        "48069 - Castro County",
        "48071 - Chambers County",
        "48073 - Cherokee County",
        "48075 - Childress County",
        "48077 - Clay County",
        "48079 - Cochran County",
        "48081 - Coke County",
        "48083 - Coleman County",
        "48085 - Collin County",
        "48087 - Collingsworth County",
        "48089 - Colorado County",
        "48091 - Comal County",
        "48093 - Comanche County",
        "48095 - Concho County",
        "48097 - Cooke County",
        "48099 - Coryell County",
        "48101 - Cottle County",
        "48103 - Crane County",
        "48105 - Crockett County",
        "48107 - Crosby County",
        "48109 - Culberson County",
        "48111 - Dallam County",
        "48113 - Dallas County",
        "48115 - Dawson County",
        "48117 - Deaf Smith County",
        "48119 - Delta County",
        "48121 - Denton County",
        "48123 - DeWitt County",
        "48125 - Dickens County",
        "48127 - Dimmit County",
        "48129 - Donley County",
        "48131 - Duval County",
        "48133 - Eastland County",
        "48135 - Ector County",
        "48137 - Edwards County",
        "48139 - Ellis County",
        "48141 - El Paso County",
        "48143 - Erath County",
        "48145 - Falls County",
        "48147 - Fannin County",
        "48149 - Fayette County",
        "48151 - Fisher County",
        "48153 - Floyd County",
        "48155 - Foard County",
        "48157 - Fort Bend County",
        "48159 - Franklin County",
        "48161 - Freestone County",
        "48163 - Frio County",
        "48165 - Gaines County",
        "48167 - Galveston County",
        "48169 - Garza County",
        "48171 - Gillespie County",
        "48173 - Glasscock County",
        "48175 - Goliad County",
        "48177 - Gonzales County",
        "48179 - Gray County",
        "48181 - Grayson County",
        "48183 - Gregg County",
        "48185 - Grimes County",
        "48187 - Guadalupe County",
        "48189 - Hale County",
        "48191 - Hall County",
        "48193 - Hamilton County",
        "48195 - Hansford County",
        "48197 - Hardeman County",
        "48199 - Hardin County",
        "48201 - Harris County",
        "48203 - Harrison County",
        "48205 - Hartley County",
        "48207 - Haskell County",
        "48209 - Hays County",
        "48211 - Hemphill County",
        "48213 - Henderson County",
        "48215 - Hidalgo County",
        "48217 - Hill County",
        "48219 - Hockley County",
        "48221 - Hood County",
        "48223 - Hopkins County",
        "48225 - Houston County",
        "48227 - Howard County",
        "48229 - Hudspeth County",
        "48231 - Hunt County",
        "48233 - Hutchinson County",
        "48235 - Irion County",
        "48237 - Jack County",
        "48239 - Jackson County",
        "48241 - Jasper County",
        "48243 - Jeff Davis County",
        "48245 - Jefferson County",
        "48247 - Jim Hogg County",
        "48249 - Jim Wells County",
        "48251 - Johnson County",
        "48253 - Jones County",
        "48255 - Karnes County",
        "48257 - Kaufman County",
        "48259 - Kendall County",
        "48261 - Kenedy County",
        "48263 - Kent County",
        "48265 - Kerr County",
        "48267 - Kimble County",
        "48269 - King County",
        "48271 - Kinney County",
        "48273 - Kleberg County",
        "48275 - Knox County",
        "48277 - Lamar County",
        "48279 - Lamb County",
        "48281 - Lampasas County",
        "48283 - La Salle County",
        "48285 - Lavaca County",
        "48287 - Lee County",
        "48289 - Leon County",
        "48291 - Liberty County",
        "48293 - Limestone County",
        "48295 - Lipscomb County",
        "48297 - Live Oak County",
        "48299 - Llano County",
        "48301 - Loving County",
        "48303 - Lubbock County",
        "48305 - Lynn County",
        "48307 - McCulloch County",
        "48309 - McLennan County",
        "48311 - McMullen County",
        "48313 - Madison County",
        "48315 - Marion County",
        "48317 - Martin County",
        "48319 - Mason County",
        "48321 - Matagorda County",
        "48323 - Maverick County",
        "48325 - Medina County",
        "48327 - Menard County",
        "48329 - Midland County",
        "48331 - Milam County",
        "48333 - Mills County",
        "48335 - Mitchell County",
        "48337 - Montague County",
        "48339 - Montgomery County",
        "48341 - Moore County",
        "48343 - Morris County",
        "48345 - Motley County",
        "48347 - Nacogdoches County",
        "48349 - Navarro County",
        "48351 - Newton County",
        "48353 - Nolan County",
        "48355 - Nueces County",
        "48357 - Ochiltree County",
        "48359 - Oldham County",
        "48361 - Orange County",
        "48363 - Palo Pinto County",
        "48365 - Panola County",
        "48367 - Parker County",
        "48369 - Parmer County",
        "48371 - Pecos County",
        "48373 - Polk County",
        "48375 - Potter County",
        "48377 - Presidio County",
        "48379 - Rains County",
        "48381 - Randall County",
        "48383 - Reagan County",
        "48385 - Real County",
        "48387 - Red River County",
        "48389 - Reeves County",
        "48391 - Refugio County",
        "48393 - Roberts County",
        "48395 - Robertson County",
        "48397 - Rockwall County",
        "48399 - Runnels County",
        "48401 - Rusk County",
        "48403 - Sabine County",
        "48405 - San Augustine County",
        "48407 - San Jacinto County",
        "48409 - San Patricio County",
        "48411 - San Saba County",
        "48413 - Schleicher County",
        "48415 - Scurry County",
        "48417 - Shackelford County",
        "48419 - Shelby County",
        "48421 - Sherman County",
        "48423 - Smith County",
        "48425 - Somervell County",
        "48427 - Starr County",
        "48429 - Stephens County",
        "48431 - Sterling County",
        "48433 - Stonewall County",
        "48435 - Sutton County",
        "48437 - Swisher County",
        "48439 - Tarrant County",
        "48441 - Taylor County",
        "48443 - Terrell County",
        "48445 - Terry County",
        "48447 - Throckmorton County",
        "48449 - Titus County",
        "48451 - Tom Green County",
        "48453 - Travis County",
        "48455 - Trinity County",
        "48457 - Tyler County",
        "48459 - Upshur County",
        "48461 - Upton County",
        "48463 - Uvalde County",
        "48465 - Val Verde County",
        "48467 - Van Zandt County",
        "48469 - Victoria County",
        "48471 - Walker County",
        "48473 - Waller County",
        "48475 - Ward County",
        "48477 - Washington County",
        "48479 - Webb County",
        "48481 - Wharton County",
        "48483 - Wheeler County",
        "48485 - Wichita County",
        "48487 - Wilbarger County",
        "48489 - Willacy County",
        "48491 - Williamson County",
        "48493 - Wilson County",
        "48495 - Winkler County",
        "48497 - Wise County",
        "48499 - Wood County",
        "48501 - Yoakum County",
        "48503 - Young County",
        "48505 - Zapata County",
        "48507 - Zavala County",
    ]
}


def get_state_array():
    search_lookup = requests.get('https://echo.epa.gov/app/scripts/facility_search/search_lookups.js')
    state_ids_string = re.search(
        r'stateArray\s*=\s*\[(?P<state_ids>(.+?))\]',
        search_lookup.text,
        re.DOTALL
    ).groupdict()['state_ids']
    state_id_lines = re.findall(r'"(.+?)"', state_ids_string)
    return list(map((lambda line: line.split(' - ', 2)[0]), state_id_lines))


q_columns = '116,70,87,104,138,2,137,3,4,5,6,1,0,7,9,164,10,165,21,123,124,15,16,55,71,90,136,105,111,56,72,91,106,47,44,46,68,85,102,109,33,35,34,59,76,93,112,153,29,28,121,36,61,78,95,107,38,39,62,79,96,108,40,41,42,43,64,81,98,2,137,3,4,5,1,0,47,44,33,38,2,3,1,15,55,71,105,68,85,102,109,35,36,39,40,43'


def download_county_csvs(state):
    state_counties = counties.get(state, ['Any'])
    for county in state_counties:
        county_string = county.split('-')[0].strip()
        print('Working on {0}_{1}'.format(state, county_string))
        r = requests.post('https://echo.epa.gov/app/proxy/proxy.php', data={
            's': 'fac',
            'responseset': 1,
            'p_st': state,
            'p_fips': county_string,
            'qcolumns': q_columns,
        })
        responseJSON = json.loads(r.text)
        if 'Error' in responseJSON['Results']:
            print('Could not load for {0}_{1}'.format(state, county_string))
            print(responseJSON['Results']['Error'])
            continue
        query_id = responseJSON['Results'].get('QueryID', None)

        if query_id is None:
            print(responseJSON)

        r_csv = requests.get('https://ofmpub.epa.gov/echo/echo_rest_services2.get_download', params={
            'qid': query_id,
            'qcolumns': q_columns,
        })
        with open('compliance_{0}_{1}.csv'.format(state, county_string), 'wb') as fd:
            for chunk in r_csv.iter_content(chunk_size=128):
                fd.write(chunk)


def download_state_csv(state):
    print('Working on {0}_{1}'.format(state, 'Any'))
    r = requests.post('https://echo.epa.gov/app/proxy/proxy.php', data={
        's': 'fac',
        'responseset': 1,
        'p_st': state,
        'qcolumns': q_columns,
    })
    responseJSON = json.loads(r.text)
    if 'Error' in responseJSON['Results']:
        print('Could not load {}'.format(state))
        download_county_csvs(state)
        return

    query_id = responseJSON['Results']['QueryID']
    r_csv = requests.get('https://ofmpub.epa.gov/echo/echo_rest_services2.get_download', params={
        'qid': query_id,
        'qcolumns': q_columns,
    })
    with open('compliance_{0}_{1}.csv'.format(state, 'Any'), 'wb') as fd:
        for chunk in r_csv.iter_content(chunk_size=128):
            fd.write(chunk)


def main():
    for state_string in get_state_array():
        download_state_csv(state_string)


if __name__ == '__main__':
    main()
